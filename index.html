<script>
    // =========================================================
    // VARI√ÅVEIS DE CONFIGURA√á√ÉO E DOM
    // =========================================================
    const KEY_STORAGE_ID = 'validAccessKey'; 
    const STATE_STORAGE_ID = 'ffAssistantAppState'; 
    const ADMIN_MASTER_KEY = 'ADM-123456-BOSS';
    
    // Elementos DOM
    const D = {
        loginForm: document.getElementById('login-form'),
        keyInput: document.getElementById('key-input'),
        loginScreen: document.getElementById('login-screen'),
        mainPanel: document.getElementById('main-hud-panel'),
        mainBody: document.getElementById('main-body'),
        loginErrorMsg: document.getElementById('login-error-message'),
        loginButtonText: document.getElementById('login-text'),
        dpiSlider: document.getElementById('dpi-slider'),
        dpiValue: document.getElementById('dpi-value'),
        keyModal: document.getElementById('key-modal'),
        adminModal: document.getElementById('admin-modal'),
        volsStatus: document.getElementById('vols-status'),
        pingCounter: document.getElementById('ping-counter'),
        pingGraph: document.getElementById('ping-graph'),

        // Bot√µes
        copyKeyModalBtn: document.getElementById('copy-key-modal-btn'),
        closeKeyModalBtn: document.getElementById('close-key-modal-btn'),
        adminGenerateBtn: document.getElementById('admin-generate-btn'),
        adminLogoutBtn: document.getElementById('admin-logout-btn'),
        activateLaunchBtn: document.getElementById('activate-launch-btn'),
        displayKeyBtn: document.getElementById('display-key-btn'),
        
        // Toggles
        toggleOptimization: document.getElementById('toggle-optimization'),
        inputOptimization: document.getElementById('toggle-optimization-input'),
        togglePrecision: document.getElementById('toggle-precision'),
        inputPrecision: document.getElementById('toggle-precision-input'),
        toggleAimguide: document.getElementById('toggle-aimguide'),
        inputAimguide: document.getElementById('toggle-aimguide-input'),
    };
    
    let appState = {
        Optimization: false, AimGuide: false, Precision: false, AimPrecisionPercentage: 50,
    };
    let pingInterval;

    // =========================================================
    // FUN√á√ïES GERAIS DE UTILIDADE
    // =========================================================

    function generateRandomSixDigits() {
        return Math.floor(100000 + Math.random() * 900000).toString();
    }

    function generateNewAccessKey(durationDays = 7) { 
        const part1 = generateRandomSixDigits();
        const part2 = generateRandomSixDigits();
        const part3 = generateRandomSixDigits();
        const newKeyString = `${part1}-${part2}-${part3}`;
        
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + durationDays);
        
        const keyData = {
            key: newKeyString,
            expiry: expiryDate.getTime(),
            durationDays: durationDays
        };
        
        localStorage.setItem(KEY_STORAGE_ID, JSON.stringify(keyData)); 
        return newKeyString;
    }
    
    function isKeyFormatValid(key) {
        const keyRegex = /^(\d{6})-(\d{6})-(\d{6})$/;
        return keyRegex.test(key);
    }
    
    // =========================================================
    // L√ìGICA DE LOGIN E AUTENTICA√á√ÉO
    // =========================================================

    async function handleLogin(event) {
        event.preventDefault(); 
        
        const enteredKey = D.keyInput.value.trim().toUpperCase();

        D.loginErrorMsg.textContent = '';
        D.loginButtonText.textContent = 'AUTENTICANDO...';
        D.loginButtonText.parentElement.disabled = true;

        await new Promise(resolve => setTimeout(resolve, 1500));
        
        if (enteredKey === ADMIN_MASTER_KEY) {
            D.keyInput.value = '';
            showAdminPanel();
            return;
        }

        const storedKeyJSON = localStorage.getItem(KEY_STORAGE_ID);
        let keyMatches = false;
        let isExpired = true;

        if (storedKeyJSON) {
            try {
                const storedKeyData = JSON.parse(storedKeyJSON);
                
                if (enteredKey === storedKeyData.key) {
                    keyMatches = true;
                    if (Date.now() < storedKeyData.expiry) {
                        isExpired = false;
                    }
                }
            } catch (e) {
                localStorage.removeItem(KEY_STORAGE_ID);
            }
        }
        
        if (!keyMatches && isKeyFormatValid(enteredKey)) {
             // Simula√ß√£o de entrega de nova chave
             const keyData = {
                 key: enteredKey,
                 expiry: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).getTime(), // 7 dias de expira√ß√£o
                 durationDays: 7
             };
             localStorage.setItem(KEY_STORAGE_ID, JSON.stringify(keyData));
             
             completeLogin();
             return;
        }

        if (keyMatches && !isExpired) {
            completeLogin();
            return;
        }

        if (keyMatches && isExpired) {
            D.loginErrorMsg.textContent = 'ERRO [COD 408]: Sua Key EXPIROU. Solicite uma nova chave.';
            localStorage.removeItem(KEY_STORAGE_ID); 
        } else {
            D.loginErrorMsg.textContent = 'ERRO [COD 403]: Chave inv√°lida, expirada ou n√£o reconhecida. Tente novamente.';
        }

        D.loginButtonText.textContent = 'CONECTAR AO SISTEMA';
        D.loginButtonText.parentElement.disabled = false;
        D.keyInput.value = '';
    }

    function completeLogin() {
        D.loginScreen.style.display = 'none';
        D.mainPanel.style.display = 'flex';
        D.mainBody.classList.remove('login-screen-container');
        
        loadAppState(); 
        initializeApp();
        updateKeyInfoInFooter(); 
    }

    // Fun√ß√£o de verifica√ß√£o de login ao carregar
    function checkLoginStatus() {
        const storedKeyJSON = localStorage.getItem(KEY_STORAGE_ID);
        
        if (storedKeyJSON) {
            try {
                const storedKeyData = JSON.parse(storedKeyJSON);
                
                if (Date.now() < storedKeyData.expiry) {
                    completeLogin(); 
                    return;
                } else {
                    localStorage.removeItem(KEY_STORAGE_ID); 
                }
            } catch (e) {
                localStorage.removeItem(KEY_STORAGE_ID);
            }
        }
        
        D.keyInput.value = ''; 
        D.loginScreen.style.display = 'flex';
        D.mainPanel.style.display = 'none';
        D.mainBody.classList.add('login-screen-container');

        loadAppState(); 
        initializeApp();
    }
    
    // =========================================================
    // GEST√ÉO DO ESTADO (APP STATE)
    // =========================================================

    function saveAppState() {
        appState.AimPrecisionPercentage = parseInt(D.dpiSlider.value);
        try {
            localStorage.setItem(STATE_STORAGE_ID, JSON.stringify(appState));
        } catch (e) { console.error("Erro ao salvar estado", e); }
    }

    function loadAppState() {
        try {
            const storedState = localStorage.getItem(STATE_STORAGE_ID);
            if (storedState) {
                const loadedState = JSON.parse(storedState);
                appState = { ...appState, ...loadedState };

                if (D.dpiSlider) {
                    D.dpiSlider.value = appState.AimPrecisionPercentage || 50;
                    updateDPI(D.dpiSlider.value, true); 
                }
                
                // Aplicar estado aos toggles
                ['Optimization', 'AimGuide', 'Precision'].forEach(feature => {
                    const inputElement = D[`input${feature}`];
                    
                    if (inputElement) {
                        const shouldBeActive = appState[feature];
                        inputElement.checked = shouldBeActive;
                        updateToggleDisplay(feature);
                    }
                });
            }
        } catch (e) { console.error("Erro ao carregar estado", e); }
    }

    function updateDPI(value, isLoad = false) {
        appState.AimPrecisionPercentage = parseInt(value);
        D.dpiValue.textContent = `${appState.AimPrecisionPercentage}%`;
        
        const percentage = value + '%';
        D.dpiSlider.style.background = `linear-gradient(to right, var(--neon-secondary) ${percentage}, var(--bg-inactive) ${percentage})`;

        if (!isLoad) { saveAppState(); }
    }

    function handleToggleClick(event) {
        const toggleElement = event.currentTarget;
        let feature = '';
        
        // Mapeia o ID do div para a feature no appState
        switch (toggleElement.id) {
            case 'toggle-optimization': feature = 'Optimization'; break;
            case 'toggle-precision': feature = 'Precision'; break;
            case 'toggle-aimguide': feature = 'AimGuide'; break;
            default: return;
        }

        const inputElement = D[`input${feature}`];
        if (inputElement) {
            inputElement.checked = !inputElement.checked; // Inverte o estado
            appState[feature] = inputElement.checked;
            
            updateToggleDisplay(feature);
            updateVolsStatus();
            saveAppState();
        }
    }

    function updateToggleDisplay(feature) {
        const toggleElement = D[`toggle${feature}`];
        const inputElement = D[`input${feature}`];
        
        if (toggleElement && inputElement) {
            const isActive = inputElement.checked;
            toggleElement.classList.toggle('active', isActive);
            // Melhoria de A11Y: Atualiza o estado ARIA
            toggleElement.setAttribute('aria-checked', isActive);
        }
    }
    
    function updateVolsStatus() {
        const activeCount = Object.values(appState).filter(val => val === true).length;
        
        if (activeCount > 0) {
            D.volsStatus.innerHTML = `MODOS ATIVOS: ${activeCount}. DIAGN√ìSTICO EM CURSO. 
            <br><span class="text-yellow-400">STATUS: CUIDADO AO INICIAR.</span>`;
        } else {
            D.volsStatus.innerHTML = `VARREDURA COMPLETA. 0 ERROS ENCUDANDO. 
            <br><span class="status-secure">SYSTEM STATUS: SECURE.</span>`;
        }
    }

    // =========================================================
    // FUNCIONALIDADES DE KEY E MODAIS
    // =========================================================

    function copyKeyToClipboard() {
        const keyElement = document.getElementById('current-valid-key');
        const key = keyElement.textContent;
        const copyBtnText = document.getElementById('copy-text');

        if (key && key !== 'CHAVE N√ÉO ENCONTRADA') {
            navigator.clipboard.writeText(key).then(() => {
                copyBtnText.textContent = '‚úÖ COPIADO!';
                setTimeout(() => { copyBtnText.textContent = 'üìã COPIAR'; }, 2000);
            }).catch(err => {
                alert("Erro ao copiar.");
            });
        }
    }

    function updateKeyInfoInFooter() {
        const storedKeyJSON = localStorage.getItem(KEY_STORAGE_ID);
        const keyFooter = document.getElementById('key-display-text');
        const keyData = storedKeyJSON ? JSON.parse(storedKeyJSON) : null;

        if (keyData && keyData.key) {
            const expiryDate = new Date(keyData.expiry);
            const formattedDate = expiryDate.toLocaleDateString('pt-BR');
            
            keyFooter.innerHTML = `KEY: ${keyData.key} (EXP: <span class="text-neon-primary">${formattedDate}</span>)`;
        } else {
            keyFooter.textContent = 'KEY: [N/A] (FA√áA LOGIN)';
        }
    }

    function displayCurrentKey() {
        const storedKeyJSON = localStorage.getItem(KEY_STORAGE_ID);
        const keyDisplayElement = document.getElementById('current-valid-key');
        const keyModalInfo = document.getElementById('key-modal-info');
        
        if (storedKeyJSON) {
            try {
                const keyData = JSON.parse(storedKeyJSON);
                const expiryDate = new Date(keyData.expiry);
                keyDisplayElement.textContent = keyData.key;
                
                const formattedDate = expiryDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                if (Date.now() >= keyData.expiry) {
                     keyModalInfo.innerHTML = `STATUS: <span class="text-red-500 font-bold">EXPIRADA!</span>`;
                } else {
                     keyModalInfo.innerHTML = `DURA√á√ÉO: ${keyData.durationDays} dias | V√°lida at√©: <span class="text-neon-secondary font-bold">${formattedDate}</span>`;
                }
            } catch (e) {
                 keyDisplayElement.textContent = 'Erro ao processar Key.';
                 keyModalInfo.textContent = '';
            }
        } else {
            keyDisplayElement.textContent = 'CHAVE N√ÉO ENCONTRADA';
            keyModalInfo.innerHTML = '<span class="text-red-500 font-bold">Status: N√£o logado.</span>';
        }
        D.keyModal.classList.remove('hidden');
    }
    
    function closeKeyModal() {
        D.keyModal.classList.add('hidden');
    }
    
    // --- ADMIN ---
    function showAdminPanel() {
        D.loginScreen.style.display = 'none'; 
        D.mainPanel.style.display = 'none';   
        D.adminModal.classList.remove('hidden'); 
        document.getElementById('admin-message').textContent = '';
    }
    
    function handleAdminLogout() {
        D.adminModal.classList.add('hidden'); 
        D.loginScreen.style.display = 'flex';
    }

    function adminGenerateNewKey() {
        const select = document.getElementById('key-duration-select');
        const durationDays = parseInt(select.value);
        
        const newKey = generateNewAccessKey(durationDays); 
        
        const adminMsg = document.getElementById('admin-message');
        adminMsg.textContent = `‚úÖ NOVA KEY GERADA: ${newKey} (Dura√ß√£o: ${durationDays} dias). COPIADA!`;
        adminMsg.style.color = '#00eaff'; 
        adminMsg.style.textShadow = '0 0 5px rgba(0, 234, 255, 0.8)';
        
        navigator.clipboard.writeText(newKey);
    }

    // =========================================================
    // FUNCIONALIDADES DE SIMULA√á√ÉO E INICIALIZA√á√ÉO
    // =========================================================

    function startPingSim() {
        let history = Array(11).fill(40); 

        clearInterval(pingInterval);

        pingInterval = setInterval(() => {
            const currentPing = Math.floor(Math.random() * (40 - 10) + 10);
            D.pingCounter.textContent = currentPing;
            
            const normalizedHeight = 50 - ((currentPing - 10) / 30) * 40; 
            
            history.shift();
            history.push(normalizedHeight);
            
            const points = history.map((h, i) => `${i * 10},${h}`).join(' ');
            D.pingGraph.setAttribute('points', points);

        }, 800);
    }

    function activateModsAndLaunch() {
        const activeCount = Object.values(appState).filter(val => val === true).length;
        if (activeCount > 0) {
            alert(`ATIVANDO: ${activeCount} MODS. INICIANDO FREE FIRE OTIMIZADO...`);
        } else {
            alert("Nenhuma fun√ß√£o ativada. Iniciando Free Fire normalmente...");
        }
        
        const deepLinkUri = "garenafreefire://";
        window.location.href = deepLinkUri;
    }

    function initializeApp() {
        if (D.dpiSlider && D.dpiValue) { updateDPI(appState.AimPrecisionPercentage, true); }
        startPingSim(); 
        updateVolsStatus();
    }

    // =========================================================
    // REGISTRO DE EVENT LISTENERS (Centraliza√ß√£o)
    // =========================================================
    
    document.addEventListener('DOMContentLoaded', checkLoginStatus);

    // Login
    if (D.loginForm) D.loginForm.addEventListener('submit', handleLogin);

    // Toggles de Fun√ß√µes
    if (D.toggleOptimization) D.toggleOptimization.addEventListener('click', handleToggleClick);
    if (D.togglePrecision) D.togglePrecision.addEventListener('click', handleToggleClick);
    if (D.toggleAimguide) D.toggleAimguide.addEventListener('click', handleToggleClick);

    // Slider DPI
    if (D.dpiSlider) D.dpiSlider.addEventListener('input', (e) => updateDPI(e.target.value));

    // Bot√µes Principais e Rodap√©
    if (D.activateLaunchBtn) D.activateLaunchBtn.addEventListener('click', activateModsAndLaunch);
    if (D.displayKeyBtn) D.displayKeyBtn.addEventListener('click', displayCurrentKey);

    // Bot√µes do Modal KEY
    if (D.copyKeyModalBtn) D.copyKeyModalBtn.addEventListener('click', copyKeyToClipboard);
    if (D.closeKeyModalBtn) D.closeKeyModalBtn.addEventListener('click', closeKeyModal);

    // Bot√µes do Modal Admin
    if (D.adminGenerateBtn) D.adminGenerateBtn.addEventListener('click', adminGenerateNewKey);
    if (D.adminLogoutBtn) D.adminLogoutBtn.addEventListener('click', handleAdminLogout);
    
</script>
</body>
</html>
